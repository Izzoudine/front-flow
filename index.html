<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flow - Ultimate Hybrid</title>
    <style>
        /* --- 1. VARIABLES & THEME FLOW --- */
        :root {
            --bg-dark: #0f172a; 
            --bg-card: #1e293b;
            --primary: #0ea5e9; 
            --primary-dark: #0284c7;
            --success: #10b981; 
            --danger: #ef4444; 
            --warning: #f59e0b; 
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* --- 2. STRUCTURE --- */
        .full-screen { 
            width: 100%; height: 100%; display: none; 
            flex-direction: column; align-items: center; 
            overflow-y: auto; padding: 20px; 
        }
        .full-screen.active { display: flex; }
        #screen-config.active { justify-content: center; }

        /* --- 3. CONFIGURATION --- */
        .brand-title { 
            font-size: 2.5rem; font-weight: 800; 
            background: linear-gradient(to right, #0ea5e9, #3b82f6); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            margin-bottom: 10px; 
        }
        .config-card { 
            background: var(--bg-card); padding: 30px; border-radius: 24px; 
            width: 100%; max-width: 450px; border: 1px solid #334155; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.4); 
        }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 10px; color: var(--text-dim); font-weight: 600; }
        
        input, select, textarea { 
            width: 100%; padding: 14px; background: #0f172a; 
            border: 1px solid #334155; border-radius: 12px; 
            color: white; font-size: 1rem; outline: none; transition: 0.2s; 
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); }
        textarea { resize: none; height: 80px; }
        
        .char-selector { display: flex; gap: 15px; }
        .char-opt { 
            flex: 1; background: #0f172a; border: 2px solid transparent; 
            padding: 15px; border-radius: 12px; text-align: center; 
            cursor: pointer; transition: 0.2s; 
        }
        .char-opt.selected { border-color: var(--primary); background: rgba(14, 165, 233, 0.1); }
        .char-emoji { font-size: 2.5rem; display: block; margin-bottom: 5px; }

        /* --- 4. NAVIGATION --- */
        nav { 
            width: 100%; background: var(--bg-card); padding: 15px; 
            display: flex; justify-content: center; gap: 15px; 
            border-bottom: 1px solid #334155; flex-shrink: 0; z-index: 10; 
        }
        .nav-btn { 
            background: transparent; border: none; color: var(--text-dim); 
            font-size: 1rem; cursor: pointer; padding: 10px 20px; 
            border-radius: 12px; display: flex; align-items: center; gap: 8px; 
            font-weight: 500; transition: 0.2s; 
        }
        .nav-btn.active { background: var(--primary); color: white; font-weight: bold; }
        .btn-quit { margin-left: auto; color: var(--danger); }

        .tab-content { 
            display: none; flex-direction: column; align-items: center; 
            width: 100%; max-width: 800px; margin: 0 auto; 
            flex: 1; overflow-y: auto; padding-bottom: 50px; 
        }
        .tab-content.active { display: flex; }

        /* --- 5. CHAT --- */
        .avatar { 
            width: 150px; height: 150px; border-radius: 50%; 
            background: #1e293b; border: 4px solid #475569; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 65px; margin-top: 30px; transition: 0.3s; 
        }
        .listening .avatar { border-color: var(--success); transform: scale(1.05); }
        .speaking .avatar { border-color: var(--primary); box-shadow: 0 0 40px rgba(14, 165, 233, 0.5); }
        .thinking .avatar { border-color: var(--warning); animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .chat-transcript { 
            text-align: center; font-size: 1.2rem; min-height: 80px; 
            width: 100%; color: #e2e8f0; margin-top: 25px; padding: 0 20px; 
        }

        /* --- 6. PITCH & STATS --- */
        .timer-display { 
            font-size: 5rem; font-weight: 800; color: var(--primary); 
            margin-top: 20px; font-variant-numeric: tabular-nums; 
            text-shadow: 0 0 30px rgba(14, 165, 233, 0.2); 
        }

        .stats-grid { 
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; 
            width: 100%; margin-top: 30px; display: none; 
        }
        .stat-card { 
            background: #1e293b; padding: 15px; border-radius: 16px; 
            text-align: center; border: 1px solid #334155; 
        }
        .stat-val { font-size: 1.8rem; font-weight: 800; color: white; }
        .stat-label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; margin-top: 5px; }
        
        /* RAPPORT QQOQCP */
        .report-panel { 
            background: var(--bg-card); padding: 30px; border-radius: 24px; 
            border-left: 6px solid var(--success); display: none; 
            margin-top: 30px; width: 100%; box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
        }
        .report-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #334155; 
        }
        .report-title { font-weight: 800; color: #fff; font-size: 1.4rem; }
        .score-badge { font-size: 3rem; color: var(--success); font-weight: 900; }

        .report-item { margin-bottom: 18px; border-bottom: 1px solid #334155; padding-bottom: 12px; }
        .report-item:last-child { border: none; }
        
        .report-key { 
            color: var(--primary); font-size: 0.85rem; font-weight: 700; 
            text-transform: uppercase; display: block; margin-bottom: 5px; 
        }
        .report-val { color: #f1f5f9; font-size: 1.05rem; line-height: 1.4; }

        /* ALERTE √âL√âMENTS MANQUANTS */
        .missing-box { 
            background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); 
            padding: 15px; border-radius: 12px; margin-bottom: 20px; display: none;
        }
        .missing-title { 
            color: var(--danger); font-weight: bold; text-transform: uppercase; 
            font-size: 0.8rem; margin-bottom: 5px; display: block; 
        }
        .missing-content { color: #fca5a5; font-size: 0.95rem; }

        .pitch-transcript-box { 
            background: #0f172a; border: 1px solid #334155; border-radius: 16px; 
            padding: 25px; width: 100%; color: #cbd5e1; margin-top: 30px; 
            white-space: pre-wrap; display: none; 
        }

        /* --- 7. BOUTONS --- */
        .btn-action { 
            padding: 18px 40px; border-radius: 50px; border: none; 
            font-size: 1.1rem; font-weight: bold; cursor: pointer; color: white; 
            background: var(--primary); margin-top: 30px; width: 100%; max-width: 320px; 
            display: flex; justify-content: center; align-items: center; gap: 12px; 
            transition: transform 0.2s; 
        }
        .btn-action:hover { transform: translateY(-2px); }
        .btn-red { background: var(--danger); }
        
        .recording-dot { width: 14px; height: 14px; background: white; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.2; } }

        @media (max-width: 600px) { 
            .nav-btn span { display: none; } 
            .timer-display { font-size: 3.5rem; } 
            .stats-grid { grid-template-columns: 1fr 1fr; } 
            .stat-card:last-child { grid-column: span 2; } 
        }

    </style>
</head>
<body>

    <div id="screen-config" class="full-screen active">
        <div class="brand-title">üåä Flow</div>
        <p style="color:#64748b; margin-top:-5px; margin-bottom:30px;" id="networkInfo">Chargement...</p>
        
        <div class="config-card">
            <div class="form-group">
                <label>Ton Coach</label>
                <div class="char-selector">
                    <div class="char-opt selected" onclick="selectChar('Lucas', 'homme', 'üßë‚Äçüéì', this)">
                        <span class="char-emoji">üßë‚Äçüéì</span> Lucas
                    </div>
                    <div class="char-opt" onclick="selectChar('Julie', 'femme', 'üë©‚Äçüíº', this)">
                        <span class="char-emoji">üë©‚Äçüíº</span> Julie
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Sujet du Pitch</label>
                <textarea id="scenarioInput" placeholder="Ex: Pitch startup, Vente produit...">Entretien d'embauche.</textarea>
            </div>

            <div class="form-group">
                <label>Personnalit√© de l'IA</label>
                <select id="behaviorInput">
                    <option>Amical et d√©tendu (Sympa)</option>
                    <option>Strict et professionnel (Challenge)</option>
                    <option>Timide et h√©sitant (Dr√¥le)</option>
                    <option>Sarcastique et piquant (Fun)</option>
                    <option>Coach militaire (Intensif)</option>
                    <option>Philosophe calme (Zen)</option>
                </select>
            </div>

            <button class="btn-action" style="width:100%" onclick="startSession()">
                üöÄ Lancer la session
            </button>
        </div>
    </div>

    <div id="screen-app" class="full-screen">
        <nav>
            <button class="nav-btn active" onclick="switchTab('chat')">üí¨ <span>Discussion</span></button>
            <button class="nav-btn" onclick="switchTab('pitch')">üåä <span>Pitch Analyzer</span></button>
            <button class="nav-btn btn-quit" onclick="location.reload()">‚ùå <span>Quitter</span></button>
        </nav>

        <div id="tab-chat" class="tab-content active">
            <div class="avatar" id="avatarDisplay">üßë‚Äçüéì</div>
            <div style="margin-top:15px; color:#64748b; font-size:0.9rem; font-weight:600;" id="chatStatus">Chargement...</div>
            
            <div class="chat-transcript">
                <span id="chatFinal" style="color:white; font-weight:600;"></span>
                <span id="chatInterim" style="color:#64748b; font-style:italic;"></span>
            </div>

            <button class="btn-action btn-red" onclick="forceStop()">
                ü§´ STOP (Silence)
            </button>
        </div>

        <div id="tab-pitch" class="tab-content">
            <div class="timer-display" id="timer">00:00</div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-val" id="statWPM">--</div>
                    <div class="stat-label">Mots / Min</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="statFillers">--</div>
                    <div class="stat-label">"Euh"</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="statPauses">--</div>
                    <div class="stat-label">Pauses > 2s</div>
                </div>
            </div>

            <div class="pitch-transcript-box" id="pitchTranscript"></div>

            <div id="reportCard" class="report-panel">
                <div class="report-header">
                    <span class="report-title">SCORE STRUCTURE</span>
                    <span class="score-badge" id="rScore">--</span>
                </div>
                
                <div class="missing-box" id="missingBox">
                    <span class="missing-title">‚ö†Ô∏è √âl√©ments Manquants (QQOQCP)</span>
                    <span class="missing-content" id="rMissing">...</span>
                </div>

                <div class="report-item">
                    <span class="report-key">1. Probl√®me & Accroche (Why)</span>
                    <span class="report-val" id="rHook">...</span>
                </div>
                <div class="report-item">
                    <span class="report-key">2. Solution & Cible (What/Who)</span>
                    <span class="report-val" id="rSol">...</span>
                </div>
                <div class="report-item">
                    <span class="report-key">3. Unicit√© & Business (Why You)</span>
                    <span class="report-val" id="rBiz">...</span>
                </div>
                <div class="report-item">
                    <span class="report-key">4. Appel √† l'action (CTA)</span>
                    <span class="report-val" id="rCta">...</span>
                </div>
                <div class="report-item">
                    <span class="report-key">üöÄ Conseil Prioritaire</span>
                    <span class="report-val" id="rTip" style="color:#fcd34d; font-weight:bold;">...</span>
                </div>
            </div>

            <button id="btnPitchAction" class="btn-action" onclick="togglePitch()">
                üéôÔ∏è Enregistrer
            </button>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. CONFIGURATION DEPLOIEMENT & NGROK
        // ==========================================
        
        const isLocal = (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1");

        let BASE_URL;
        let WS_URL;

        if (isLocal) {
            BASE_URL = "http://127.0.0.1:8001";
            WS_URL = "ws://127.0.0.1:8001/ws/listen";
            console.log("üîß Mode Local (Port 8001)");
        } else {
            // TON LIEN NGROK
            const PROD_API = "https://oscillometric-unexterminated-dionne.ngrok-free.dev"; 
            BASE_URL = PROD_API;
            WS_URL = PROD_API.replace("https://", "wss://") + "/ws/listen";
            console.log("üöÄ Mode Prod : " + PROD_API);
        }

        document.getElementById('networkInfo').textContent = isLocal ? "Mode Local" : "Mode Production";

        // FONCTION API UNIVERSELLE (Le "Fix" Ngrok)
        async function apiCall(endpoint, body) {
            const headers = { 'ngrok-skip-browser-warning': 'true' };
            if(!(body instanceof FormData)) headers['Content-Type'] = 'application/json';
            
            return fetch(`${BASE_URL}${endpoint}`, {
                method: 'POST',
                headers: headers,
                body: body instanceof FormData ? body : JSON.stringify(body)
            });
        }

        // ==========================================
        // 2. ETAT & INIT
        // ==========================================
        
        let currentMode = 'config';
        let selectedChar = 'Lucas'; 
        let selectedGender = 'homme'; 
        let selectedEmoji = 'üßë‚Äçüéì';
        
        const isChrome = ('webkitSpeechRecognition' in window);
        let recognition;

        // --- VARIABLES INTELLIGENTES (Anti-Coupure & Anti-Echo) ---
        let silenceTimer;       // Timer pour attendre le silence
        let accumulatedText = ""; // Accumule le texte tant qu'on n'est pas s√ªr
        let isProcessing = false; // "Vrai" si l'IA r√©fl√©chit ou parle

        function selectChar(name, gender, emoji, el) {
            selectedChar = name; selectedGender = gender; selectedEmoji = emoji;
            document.querySelectorAll('.char-opt').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
        }

        async function startSession() {
            try {
                await apiCall('/config', {
                    character: selectedChar,
                    gender: selectedGender,
                    scenario: document.getElementById('scenarioInput').value,
                    behavior: document.getElementById('behaviorInput').value
                });
                
                document.getElementById('screen-config').classList.remove('active');
                document.getElementById('screen-app').classList.add('active');
                document.getElementById('avatarDisplay').textContent = selectedEmoji;
                switchTab('chat');

            } catch (e) {
                alert(`ERREUR : Impossible de contacter ${BASE_URL}.`);
            }
        }

        function switchTab(tabName) {
            currentMode = tabName;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const btns = document.querySelectorAll('.nav-btn');
            if(tabName === 'chat') btns[0].classList.add('active');
            if(tabName === 'pitch') btns[1].classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (tabName === 'chat') {
                stopPitch(); 
                startChat();
            } else {
                stopPitch(); 
                stopChat();
            }
        }

        // ==========================================
        // 3. RECONNAISSANCE VOCALE INTELLIGENTE
        // ==========================================
        
        function startChat() {
            if (!isChrome) { alert("Utilisez Chrome pour le mode conversation."); return; }
            if (recognition) { try{ recognition.start(); } catch(e){} return; }

            recognition = new window.webkitSpeechRecognition();
            recognition.lang = "fr-FR";
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onresult = (event) => {
                // Si l'IA est d√©j√† en train de r√©fl√©chir ou parler, on ignore tout (Anti-Echo Radical)
                if (isProcessing) return;

                let interim = "";
                let finalChunk = "";

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) finalChunk += event.results[i][0].transcript;
                    else interim += event.results[i][0].transcript;
                }
                
                document.getElementById('chatInterim').textContent = interim;
                
                if (finalChunk) {
                    accumulatedText += finalChunk + " ";
                    document.getElementById('chatFinal').textContent = accumulatedText;

                    // --- DEBOUNCE (La Patience) ---
                    // On n'envoie PAS tout de suite. On attend 1.5s de silence complet.
                    clearTimeout(silenceTimer);
                    silenceTimer = setTimeout(() => {
                        if (accumulatedText.trim().length > 0) {
                            sendToBrain(accumulatedText);
                            accumulatedText = ""; // On vide le buffer
                        }
                    }, 1500); // 1.5 secondes de patience
                }
            };
            
            recognition.onend = () => {
                // Relance auto sauf si on a coup√© volontairement
                if (!isProcessing && currentMode === 'chat') {
                    try { recognition.start(); } catch(e){}
                }
            };

            try { recognition.start(); } catch(e){}
            document.getElementById('chatStatus').textContent = "Je vous √©coute...";
            document.getElementById('avatarDisplay').className = "avatar listening";
        }

        function stopChat() {
            if (recognition) recognition.abort();
            clearTimeout(silenceTimer);
        }

        // ==========================================
        // 4. CERVEAU + GESTION AUDIO (KILL SWITCH)
        // ==========================================
        async function sendToBrain(text) {
            // 1. KILL SWITCH : On coupe le micro IMM√âDIATEMENT
            isProcessing = true;
            if (recognition) recognition.abort();
            clearTimeout(silenceTimer);

            // UI
            const avatar = document.getElementById('avatarDisplay');
            const status = document.getElementById('chatStatus');
            avatar.className = "avatar thinking";
            status.textContent = "üß† R√©flexion...";
            document.getElementById('chatInterim').textContent = ""; // Nettoyage

            try {
                // Appel API
                const res = await apiCall('/chat', {text: text});
                if (!res.ok) throw new Error("Erreur serveur");

                // Lecture Audio
                const blob = await res.blob();
                const audioUrl = URL.createObjectURL(blob);
                const audio = new Audio(audioUrl);

                audio.onplay = () => {
                    avatar.className = "avatar speaking";
                    status.textContent = "üîä Flow parle...";
                    status.style.color = "#0ea5e9";
                };

                audio.onended = () => {
                    // 2. R√âSURRECTION : On ne rallume le micro que maintenant
                    avatar.className = "avatar listening";
                    status.textContent = "√Ä vous...";
                    status.style.color = "#64748b";
                    
                    // Petit d√©lai de s√©curit√© (500ms) pour √©viter l'√©cho du haut-parleur
                    setTimeout(() => {
                        isProcessing = false;
                        if (currentMode === 'chat') startChat();
                    }, 500);
                };

                audio.play();

            } catch (e) {
                console.error(e);
                avatar.className = "avatar listening";
                status.textContent = "üî¥ Erreur";
                isProcessing = false; // En cas d'erreur, on rend la main
                startChat();
            }
        }

        async function forceStop() {
            await apiCall('/stop');
            // Reset √©tat
            isProcessing = false;
            stopChat();
            startChat();
        }

        // ==========================================
        // 5. PITCH LOGIC (INCHANG√â MAIS CONNECT√â)
        // ==========================================
        let mediaRecorder, chunks=[], timerInt, startTime;
        let isPitchRecording = false;

        async function getMicrophone() {
            try { return await navigator.mediaDevices.getUserMedia({ audio: true }); } catch(e) { return null; }
        }

        async function togglePitch() {
            if (!isPitchRecording) {
                stopChat(); // Important : couper le chat vocal
                
                document.getElementById('btnPitchAction').textContent = "‚è≥...";
                const stream = await getMicrophone();
                if (!stream) { document.getElementById('btnPitchAction').textContent = "üéôÔ∏è Enregistrer"; return; }

                mediaRecorder = new MediaRecorder(stream);
                chunks = [];
                mediaRecorder.ondataavailable = event => chunks.push(event.data);
                
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    analyzeAudio(blob);
                };

                mediaRecorder.start();
                isPitchRecording = true;
                
                document.getElementById('btnPitchAction').innerHTML = '<div class="recording-dot"></div> Arr√™ter';
                document.getElementById('btnPitchAction').classList.add('btn-red');
                document.getElementById('pitchTranscript').style.display = 'block';
                document.getElementById('pitchTranscript').textContent = "üî¥ Enregistrement...";
                document.getElementById('reportCard').style.display = 'none';
                document.getElementById('statsGrid').style.display = 'none';

                startTime = Date.now();
                timerInt = setInterval(() => {
                    const d = Math.floor((Date.now() - startTime)/1000);
                    const m = String(Math.floor(d/60)).padStart(2,'0');
                    const s = String(d%60).padStart(2,'0');
                    document.getElementById('timer').textContent = `${m}:${s}`;
                }, 1000);

            } else {
                if(mediaRecorder) mediaRecorder.stop();
                isPitchRecording = false;
                clearInterval(timerInt);
                document.getElementById('btnPitchAction').textContent = "‚è≥ Analyse...";
                document.getElementById('btnPitchAction').classList.remove('btn-red');
            }
        }

        async function analyzeAudio(blob) {
            const formData = new FormData();
            formData.append("file", blob, "pitch.webm");
            try {
                const res = await apiCall('/analyze_audio', formData);
                const data = await res.json();
                
                if (data.status === 'error') { alert("Erreur: " + data.message); return; }

                document.getElementById('statsGrid').style.display = 'grid';
                document.getElementById('statWPM').textContent = data.metrics.wpm;
                document.getElementById('statFillers').textContent = data.metrics.fillers;
                document.getElementById('statPauses').textContent = data.metrics.pauses;
                document.getElementById('pitchTranscript').textContent = data.metrics.transcript;
                
                let report; try{ report = JSON.parse(data.advice.replace(/```json/g,'').replace(/```/g,'').trim()); }
                catch(e) { report = {note:"?", conseil: "Erreur parsing JSON"}; }

                document.getElementById('rScore').textContent = report.note || "?";
                document.getElementById('rHook').textContent = report.accroche_probleme || "-";
                document.getElementById('rSol').textContent = report.solution_cible || "-";
                document.getElementById('rBiz').textContent = report.unicite_business || "-";
                document.getElementById('rCta').textContent = report.cta_action || "-";
                document.getElementById('rTip').textContent = report.conseil || "-";

                const missingBox = document.getElementById('missingBox');
                if (report.elements_manquants && report.elements_manquants.length > 5 && !report.elements_manquants.includes("Aucun")) {
                    missingBox.style.display = 'block';
                    document.getElementById('rMissing').textContent = report.elements_manquants;
                } else { missingBox.style.display = 'none'; }

                document.getElementById('reportCard').style.display = 'block';
                document.getElementById('btnPitchAction').textContent = "üéôÔ∏è Recommencer";

            } catch(e) { console.error(e); alert("Erreur r√©seau"); }
        }

    </script>
</body>
</html>