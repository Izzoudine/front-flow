<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flow - Ultimate Audio Fix</title>
   <style>
        /* --- THEME GENERAL --- */
        :root { 
            --bg: #0f172a; 
            --card: #1e293b; 
            --primary: #0ea5e9; 
            --text: #f8fafc; 
            --success: #10b981;
            --danger: #ef4444;
        }
        * { box-sizing: border-box; }
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* --- LAYOUT --- */
        .full-screen { 
            display: none; 
            width: 100%; 
            height: 100%; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px; 
            overflow-y: auto; 
        }
        .full-screen.active { display: flex; }
        
        /* --- VISUALISEUR AUDIO (Le plus important) --- */
        .vad-wrapper {
            width: 100%;
            max-width: 300px;
            margin: 20px 0;
            text-align: center;
        }
        .vad-container { 
            width: 100%; 
            height: 20px; 
            background: #334155; 
            border-radius: 10px; 
            position: relative; 
            overflow: hidden; 
            margin-top: 5px;
        }
        .vad-bar { 
            height: 100%; 
            background: var(--success); 
            width: 0%; 
            transition: width 0.05s linear; 
        }
        .vad-threshold { 
            position: absolute; 
            left: 10%; /* Sera ajust√© par le JS */
            top: 0; 
            bottom: 0; 
            width: 2px; 
            background: var(--danger); 
            z-index: 10; 
        } 

        /* --- ELEMENTS UI --- */
        .avatar { 
            width: 140px; 
            height: 140px; 
            border-radius: 50%; 
            background: #1e293b; 
            border: 4px solid #475569; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 60px; 
            margin-top: 30px; 
            transition: 0.3s; 
        }
        .avatar.speaking { 
            border-color: var(--primary); 
            box-shadow: 0 0 30px rgba(14,165,233,0.5); 
            transform: scale(1.05);
        }
        .avatar.thinking {
            border-color: #f59e0b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse { 50% { opacity: 0.6; } }

        .btn-action { 
            padding: 15px 30px; 
            border-radius: 50px; 
            border: none; 
            font-weight: bold; 
            color: white; 
            background: var(--primary); 
            width: 100%; 
            max-width: 300px; 
            margin-top: 30px; 
            cursor: pointer; 
            font-size: 1.1rem;
        }
        .btn-red { background: var(--danger); }

        .chat-text { 
            text-align: center; 
            margin-top: 20px; 
            color: #cbd5e1; 
            min-height: 40px; 
            padding: 0 10px; 
            font-style: italic;
        }
        
        #statusText {
            font-weight: bold;
            margin-top: 10px;
            height: 20px;
            color: #64748b;
        }

        /* --- CONFIG FORM --- */
        .config-card { 
            background: var(--card); 
            padding: 25px; 
            border-radius: 20px; 
            width: 100%; 
            max-width: 400px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        input, select, textarea { 
            width: 100%; padding: 12px; 
            background: #0f172a; border: 1px solid #334155; 
            color: white; border-radius: 8px; margin-bottom: 15px; 
            display: block; font-family: inherit;
        }
        label { color: #94a3b8; font-size: 0.9rem; margin-bottom: 5px; display: block; font-weight: bold;}
        
        /* --- NAVIGATION --- */
        nav { 
            width: 100%; background: var(--card); padding: 10px; 
            display: flex; justify-content: center; gap: 10px; 
            margin-bottom: 10px;
        }
        .nav-btn { 
            background: transparent; border: none; color: #94a3b8; 
            font-size: 1rem; cursor: pointer; padding: 10px 20px; 
            font-weight: 500;
        }
        .nav-btn.active { color: var(--primary); font-weight: bold; border-bottom: 2px solid var(--primary); }

        /* --- SELECTION PERSONNAGE --- */
        .char-selector { display: flex; gap: 15px; margin-bottom: 15px; }
        .char-opt { 
            flex: 1; background: #0f172a; border: 2px solid transparent; 
            padding: 10px; border-radius: 12px; text-align: center; 
            cursor: pointer; transition: 0.2s; 
        }
        .char-opt.selected { border-color: var(--primary); background: rgba(14, 165, 233, 0.1); }
        .char-emoji { font-size: 2rem; display: block; margin-bottom: 5px; }

        /* --- PITCH STATS --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 100%; margin-top: 20px; display: none; }
        .stat-card { background: #1e293b; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #334155; }
        .stat-val { font-size: 1.5rem; font-weight: bold; }
        .stat-label { font-size: 0.7rem; color: #94a3b8; }
        .report-panel { background: #1e293b; padding: 20px; margin-top: 20px; border-radius: 15px; display: none; text-align: left; }
        .report-item { border-bottom: 1px solid #334155; padding: 10px 0; }
        .report-key { color: var(--primary); font-size: 0.8rem; font-weight: bold; display: block; }

    </style>
</head>
<body>

    <div id="screen-config" class="full-screen active" style="justify-content: center;">
        <h1 style="color:#0ea5e9; margin-bottom: 20px;">üåä Flow</h1>
        <p style="color:#64748b; margin-top:-15px; margin-bottom:20px;" id="networkInfo">Pr√™t √† d√©marrer</p>
        
        <div class="config-card">
            <label>Ton Coach</label>
            <div class="char-selector">
                <div class="char-opt selected" onclick="selectChar('Lucas', 'homme', 'üßë‚Äçüéì', this)">
                    <span class="char-emoji">üßë‚Äçüéì</span> Lucas
                </div>
                <div class="char-opt" onclick="selectChar('Julie', 'femme', 'üë©‚Äçüíº', this)">
                    <span class="char-emoji">üë©‚Äçüíº</span> Julie
                </div>
            </div>

            <label>Sc√©nario</label>
            <textarea id="scenarioInput" rows="3">Entretien d'embauche pour un poste de d√©veloppeur.</textarea>
            
            <label>Personnalit√©</label>
            <select id="behaviorInput">
                <option>Amical et d√©tendu</option>
                <option>Strict et professionnel</option>
                <option>Curieux et bavard</option>
            </select>
            
            <button class="btn-action" onclick="startSession()">üöÄ Commencer</button>
        </div>
    </div>

    <div id="screen-app" class="full-screen">
        <nav>
            <button class="nav-btn active" onclick="switchTab('chat')">Discussion</button>
            <button class="nav-btn" onclick="switchTab('pitch')">Pitch Analyzer</button>
            <button class="nav-btn" onclick="location.reload()" style="color:var(--danger)">Quitter</button>
        </nav>

        <div id="tab-chat" style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <div class="avatar" id="avatarDisplay">üßë‚Äçüéì</div>
            
            <div id="statusText">Initialisation...</div>

            <div class="vad-wrapper">
                <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#64748b;">
                    <span>Micro</span>
                    <span id="volValue">0</span>
                </div>
                <div class="vad-container">
                    <div class="vad-threshold" id="visualThreshold"></div> 
                    <div class="vad-bar" id="vadBar"></div>
                </div>
                <div style="font-size: 0.75rem; color: #475569; margin-top: 5px;">
                    Si la barre d√©passe la ligne rouge, j'enregistre.
                </div>
            </div>

            <div class="chat-text" id="chatFinal">...</div>
            
            <button class="btn-action btn-red" onclick="forceStop()">üõë STOP URGENCE</button>
        </div>

        <div id="tab-pitch" style="display:none; width:100%; flex-direction:column; align-items:center;">
            <div style="font-size:4rem; font-weight:bold; color:var(--primary); margin-top:20px;" id="timer">00:00</div>
            
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card"><div class="stat-val" id="statWPM">--</div><div class="stat-label">WPM</div></div>
                <div class="stat-card"><div class="stat-val" id="statFillers">--</div><div class="stat-label">EUH</div></div>
                <div class="stat-card"><div class="stat-val" id="statPauses">--</div><div class="stat-label">PAUSES</div></div>
            </div>

            <div id="reportCard" class="report-panel">
                <div style="font-size:1.5rem; font-weight:bold; color:white; margin-bottom:10px;">Note: <span id="rScore" style="color:var(--success)">--</span></div>
                <div class="report-item"><span class="report-key">Accroche</span><span id="rHook">...</span></div>
                <div class="report-item"><span class="report-key">Solution</span><span id="rSol">...</span></div>
                <div class="report-item"><span class="report-key">Conseil</span><span id="rTip" style="color:#fcd34d">...</span></div>
                <div id="missingBox" style="margin-top:10px; color:var(--danger); font-size:0.9rem; display:none;"></div>
            </div>

            <button id="btnPitchAction" class="btn-action" onclick="togglePitch()">üéôÔ∏è Enregistrer Pitch</button>
        </div>
    </div>

<script>
    // ==========================================
    // 1. CONFIGURATION R√âSEAU
    // ==========================================
   // ============================================
    // 1. REGLAGES & CONSTANTES
    // ============================================
    const isLocal = (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1");
    // --- IMPORTANT : METS TON URL NGROK ICI ---
    const PROD_API = "https://back-flow.onrender.com"; 
    const BASE_URL = isLocal ? "http://127.0.0.1:8001" : PROD_API;
    
    // SENSIBILIT√â MICRO (0 √† 100)
    // 10 = Standard. Baisse √† 5 si √ßa ne d√©tecte pas ta voix. Monte √† 15 si le vent d√©clenche.
    const THRESHOLD = 10; 
    
    // Dur√©e de silence pour valider la fin de phrase (ms)
    const SILENCE_DURATION = 800; 

    // Mise √† jour visuelle imm√©diate du seuil rouge
    // On multiplie par 2 car l'affichage de la barre verte est amplifi√© x2
    const visualThresholdPos = Math.min(100, THRESHOLD * 2);
    document.getElementById('visualThreshold').style.left = visualThresholdPos + "%";

    // ============================================
    // 2. VARIABLES GLOBALES
    // ============================================
    let audioContext, analyser, microphone, recorder;
    let globalStream; // Pour garder le micro ouvert
    let audioChunks = [];
    
    // √âtats du Chat
    let isRecording = false; // Le recorder tourne-t-il ?
    let isSpeaking = false;  // L'utilisateur parle-t-il (volume > seuil) ?
    let silenceTimer = null; // Timer pour d√©tecter la fin de phrase
    let currentAudioPlay = null; // L'audio de la r√©ponse IA

    // √âtats du Pitch
    let isPitchRecording = false;
    let pitchRecorder, pitchChunks=[], timerInt, startTime;

    // Configuration par d√©faut
    let selectedChar = 'Lucas'; 
    let selectedGender = 'homme';
    let selectedEmoji = 'üßë‚Äçüéì';

    // ============================================
    // 3. FONCTIONS API G√âN√âRIQUES
    // ============================================
  async function apiCall(endpoint, body) {
    // On garde le header ngrok SEULEMENT si on est en local (au cas o√π tu re-develops plus tard)
    const headers = {};
    
    // Si c'est du JSON standard (pas un fichier audio)
    if(!(body instanceof FormData)) {
        headers['Content-Type'] = 'application/json';
    }

    return fetch(`${BASE_URL}${endpoint}`, {
        method: 'POST',
        headers: headers, // Plus besoin de 'ngrok-skip-...' obligatoirement
        body: body instanceof FormData ? body : JSON.stringify(body)
    });
}

    function selectChar(n,g,e,el){ 
        selectedChar=n; selectedGender=g; selectedEmoji=e; 
        document.querySelectorAll('.char-opt').forEach(x=>x.classList.remove('selected')); 
        el.classList.add('selected'); 
    }

    // ============================================
    // 4. INITIALISATION DE LA SESSION
    // ============================================
    async function startSession() {
        try {
            document.getElementById('networkInfo').textContent = "Configuration...";
            
            await apiCall('/config', {
                character: selectedChar, 
                gender: selectedGender,
                scenario: document.getElementById('scenarioInput').value,
                behavior: document.getElementById('behaviorInput').value
            });
            
            // Changement d'√©cran
            document.getElementById('screen-config').classList.remove('active');
            document.getElementById('screen-app').classList.add('active');
            document.getElementById('avatarDisplay').textContent = selectedEmoji;
            
            // D√©marrage du moteur audio imm√©diatement
            initAudio();

        } catch(e) {
            alert("Erreur connexion serveur : " + e + "\nV√©rifiez que le serveur Python tourne.");
        }
    }

    function switchTab(tab) {
        // Nettoyage avant changement d'onglet
        if(isRecording) forceStopRecording(); 
        if(isPitchRecording) togglePitch(); // Arr√™te proprement le pitch
        if(currentAudioPlay) { currentAudioPlay.pause(); currentAudioPlay = null; }

        // Gestion UI des onglets
        document.getElementById('tab-chat').style.display = 'none';
        document.getElementById('tab-pitch').style.display = 'none';
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        
        if (tab === 'chat') {
            document.getElementById('tab-chat').style.display = 'flex';
            document.querySelectorAll('.nav-btn')[0].classList.add('active');
            // Relance l'√©coute Chat
            startListening(); 
        } else {
            document.getElementById('tab-pitch').style.display = 'flex';
            document.querySelectorAll('.nav-btn')[1].classList.add('active');
            // Le chat ne doit pas √©couter en arri√®re-plan
            if(recorder && recorder.state !== 'inactive') recorder.stop();
            isRecording = false;
        }
    }

    // ============================================
    // 5. MOTEUR AUDIO CHAT (CORE)
    // ============================================
    async function initAudio() {
        try {
            // Demande l'acc√®s au micro une bonne fois pour toutes
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            globalStream = stream; 
            
            // Setup Audio Context pour l'analyse visuelle (VAD)
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 512; // R√©solution de l'analyse
            
            microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);

            updateStatus("Micro connect√©.", "#64748b");
            
            // Lance l'√©coute (Recorder)
            startListening();
            
            // Lance l'analyse visuelle (Boucle infinie)
            analyzeVolume(); 

        } catch (e) {
            alert("ERREUR MICRO : " + e.message + "\n\n1. V√©rifiez que vous √™tes en HTTPS ou localhost.\n2. Autorisez le micro dans le navigateur.");
        }
    }

    function startListening() {
        // S√©curit√© : ne pas lancer deux fois, ni si on est pas sur l'onglet chat
        if (isRecording) return;
        if (!globalStream) return;
        if (document.getElementById('tab-chat').style.display === 'none') return;
        
        // Cr√©ation d'un nouveau MediaRecorder
        // On laisse le navigateur choisir le meilleur format (souvent webm/opus)
        recorder = new MediaRecorder(globalStream);
        audioChunks = [];

        recorder.ondataavailable = e => {
            if (e.data.size > 0) audioChunks.push(e.data);
        };

        // GESTION DE L'ARR√äT (C'est ici qu'on d√©cide d'envoyer ou pas)
        recorder.onstop = () => {
            // On ne traite que si on a des donn√©es ET qu'on est toujours en mode Chat
            if (audioChunks.length > 0 && document.getElementById('tab-chat').style.display !== 'none') {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                
                // FILTRE ANTI-BRUIT : Si le fichier fait moins de 2ko, c'est probablement juste du souffle
                if (blob.size > 2000) { 
                    sendToBrain(blob);
                } else {
                    console.log("Audio trop court (bruit), ignor√©.");
                    updateStatus("Ignor√© (bruit ambiant)", "#64748b");
                    // On relance l'√©coute rapidement
                    setTimeout(() => {
                        if (!currentAudioPlay) startListening(); 
                    }, 500);
                }
            } else {
                // Si arr√™t bizarre, on relance si besoin
                if (!currentAudioPlay && document.getElementById('tab-chat').style.display !== 'none') {
                    startListening();
                }
            }
        };

        recorder.start();
        isRecording = true;
        
        updateStatus("üé§ Je vous √©coute...", "#94a3b8");
        document.getElementById('avatarDisplay').className = "avatar";
        document.getElementById('avatarDisplay').style.borderColor = "#475569";
    }

    function analyzeVolume() {
        // Cette fonction tourne en boucle (environ 60 fois par seconde)
        if(!analyser) return;

        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(dataArray);

        // 1. Calcul du volume moyen actuel
        let sum = 0;
        for(let i = 0; i < bufferLength; i++) sum += dataArray[i];
        let average = sum / bufferLength; 

        // 2. Mise √† jour de la barre verte (UI)
        const visualVal = Math.min(100, average * 2); // Amplification x2 pour visibilit√©
        document.getElementById('vadBar').style.width = visualVal + "%";
        document.getElementById('volValue').textContent = Math.round(average);

        // 3. Logique VAD (Voice Activity Detection)
        // On ne fait √ßa que si l'onglet Chat est actif et qu'on n'est pas en train d'√©couter une r√©ponse
        if (document.getElementById('tab-chat').style.display !== 'none' && !currentAudioPlay) {
            
            if (average > THRESHOLD) {
                // --- CAS A : L'utilisateur parle ---
                if (!isSpeaking) {
                    isSpeaking = true;
                    updateStatus("üîä Voix d√©tect√©e !", "#10b981"); // Vert
                    document.getElementById('avatarDisplay').style.borderColor = "#10b981";
                }
                // Tant qu'on parle, on annule tout timer de silence pr√©vu
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                    silenceTimer = null;
                }
            
            } else if (isSpeaking) {
                // --- CAS B : Silence apr√®s avoir parl√© ---
                if (!silenceTimer) {
                    updateStatus("‚è≥ Fin de phrase ?", "#f59e0b"); // Orange
                    document.getElementById('avatarDisplay').style.borderColor = "#f59e0b";
                    
                    // On lance le compte √† rebours avant envoi
                    silenceTimer = setTimeout(() => {
                        commitRecording(); // TEMPS √âCOUL√â -> ON ENVOIE
                    }, SILENCE_DURATION);
                }
            }
        }

        // Relance la boucle au prochain rafra√Æchissement d'√©cran
        requestAnimationFrame(analyzeVolume);
    }

    function commitRecording() {
        // Cette fonction est appel√©e quand le silence est confirm√©
        isSpeaking = false;
        
        if (isRecording) {
            isRecording = false;
            updateStatus("üöÄ Envoi en cours...", "#0ea5e9"); // Bleu
            // Stopper le recorder d√©clenche automatiquement l'√©v√©nement 'onstop' d√©fini plus haut
            recorder.stop(); 
        }
        
        clearTimeout(silenceTimer);
        silenceTimer = null;
    }
    
    function forceStopRecording() {
        if (recorder && recorder.state !== 'inactive') {
            recorder.stop();
        }
        isRecording = false;
        isSpeaking = false;
        clearTimeout(silenceTimer);
    }

    // ============================================
    // 6. ENVOI ET RECEPTION (Backend Gemini)
    // ============================================
    async function sendToBrain(blob) {
        // UI : Mode R√©flexion
        document.getElementById('avatarDisplay').className = "avatar thinking";
        document.getElementById('avatarDisplay').style.borderColor = "#f59e0b";
        updateStatus("üß† Gemini r√©fl√©chit...", "#f59e0b");
        
        const fd = new FormData();
        fd.append("audio_file", blob, "user_input.webm");

        try {
            // Appel API
            const res = await apiCall('/chat_audio', fd);
            
            if (!res.ok) {
                // Gestion des erreurs HTTP (ex: 400 Bad Request)
                const errText = await res.text();
                throw new Error("Erreur serveur : " + errText);
            }
            
            // R√©ception de l'audio de r√©ponse
            const audioBlob = await res.blob();
            const url = URL.createObjectURL(audioBlob);
            
            // Lecture
            currentAudioPlay = new Audio(url);
            
            currentAudioPlay.onplay = () => {
                document.getElementById('avatarDisplay').className = "avatar speaking";
                document.getElementById('avatarDisplay').style.borderColor = "#0ea5e9";
                updateStatus("üîä Flow parle...", "#0ea5e9");
                document.getElementById('chatFinal').textContent = "(Lecture audio en cours...)";
            };
            
            currentAudioPlay.onended = () => {
                document.getElementById('avatarDisplay').className = "avatar";
                currentAudioPlay = null;
                // --- BOUCLE : ON RELANCE L'ECOUTE AUTOMATIQUEMENT ---
                if (document.getElementById('tab-chat').style.display !== 'none') {
                    startListening(); 
                }
            };
            
            currentAudioPlay.play();

        } catch (e) {
            console.error(e);
            updateStatus("Erreur : " + e.message, "#ef4444");
            // En cas d'erreur, on attend 2s et on relance l'√©coute pour ne pas bloquer l'app
            setTimeout(() => { 
                if (document.getElementById('tab-chat').style.display !== 'none') startListening(); 
            }, 2000);
        }
    }

    // ============================================
    // 7. FONCTION DE PITCH (MANUEL)
    // ============================================
    async function togglePitch() {
        if (!isPitchRecording) {
            // --- DEMARRAGE ENREGISTREMENT PITCH ---
            
            // On s'assure d'avoir un stream frais
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            pitchRecorder = new MediaRecorder(stream);
            pitchChunks = [];
            
            pitchRecorder.ondataavailable = e => pitchChunks.push(e.data);
            
            pitchRecorder.onstop = async () => {
                // LOGIQUE FIN ENREGISTREMENT
                if(pitchChunks.length === 0) return;
                
                const fd = new FormData(); 
                fd.append("file", new Blob(pitchChunks, { type: 'audio/webm' }), "pitch.webm");
                
                document.getElementById('btnPitchAction').textContent = "‚åõ Analyse intelligente...";
                document.getElementById('btnPitchAction').style.background = "#f59e0b"; // Orange
                
                try {
                    const res = await apiCall('/analyze_audio', fd);
                    const data = await res.json();
                    
                    if(data.status === 'error') throw new Error(data.message);

                    // 1. Affichage Stats
                    document.getElementById('statsGrid').style.display = 'grid';
                    document.getElementById('statWPM').textContent = data.metrics.wpm;
                    document.getElementById('statFillers').textContent = data.metrics.fillers;
                    document.getElementById('statPauses').textContent = data.metrics.pauses;
                    
                    // 2. Parsing Rapport Gemini
                    // On nettoie le markdown si pr√©sent (```json ... ```)
                    let cleanJson = data.advice.replace(/```json/g,'').replace(/```/g,'').trim();
                    let rep = JSON.parse(cleanJson);
                    
                    // 3. Affichage Rapport
                    document.getElementById('reportCard').style.display = 'block';
                    document.getElementById('rScore').textContent = rep.note;
                    document.getElementById('rHook').textContent = rep.accroche_probleme;
                    document.getElementById('rSol').textContent = rep.solution_cible;
                    document.getElementById('rTip').textContent = rep.conseil;

                    // Affichage des √©l√©ments manquants seulement s'il y en a
                    const missingBox = document.getElementById('missingBox');
                    if (rep.elements_manquants && rep.elements_manquants.length > 3 && !rep.elements_manquants.includes("Aucun")) {
                        missingBox.style.display = 'block';
                        missingBox.textContent = "‚ö†Ô∏è Manquant : " + rep.elements_manquants;
                    } else {
                        missingBox.style.display = 'none';
                    }

                } catch(e) { 
                    alert("Erreur Analyse Pitch : " + e); 
                }
                
                // Reset Bouton
                document.getElementById('btnPitchAction').textContent = "üéôÔ∏è Recommencer un Pitch";
                document.getElementById('btnPitchAction').className = "btn-action";
                document.getElementById('btnPitchAction').style.background = ""; // Reset couleur
            };

            pitchRecorder.start();
            isPitchRecording = true;
            
            // UI Enregistrement
            document.getElementById('btnPitchAction').textContent = "üõë Terminer l'enregistrement";
            document.getElementById('btnPitchAction').className = "btn-action btn-red";
            
            // Timer
            startTime = Date.now();
            timerInt = setInterval(()=> {
                const d = Math.floor((Date.now()-startTime)/1000);
                document.getElementById('timer').textContent = `${String(Math.floor(d/60)).padStart(2,'0')}:${String(d%60).padStart(2,'0')}`;
            }, 1000);

        } else {
            // --- ARRET ENREGISTREMENT PITCH ---
            clearInterval(timerInt);
            isPitchRecording = false;
            document.getElementById('btnPitchAction').textContent = "Envoi au cloud...";
            if(pitchRecorder) pitchRecorder.stop();
        }
    }

    // ============================================
    // 8. BOUTON STOP URGENCE
    // ============================================
    function forceStop() {
        // Arr√™t imm√©diat de tout
        if (recorder && recorder.state !== "inactive") recorder.stop();
        if (pitchRecorder && pitchRecorder.state !== "inactive") pitchRecorder.stop();
        if (currentAudioPlay) { currentAudioPlay.pause(); currentAudioPlay = null; }
        
        // Appel API pour reset c√¥t√© serveur
        apiCall('/stop');
        
        // Rechargement page pour un √©tat propre
        location.reload();
    }

    function updateStatus(text, color) {
        const el = document.getElementById('statusText');
        el.textContent = text;
        if(color) el.style.color = color;
    }
</script>
</body>
</html>